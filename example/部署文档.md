# MySQL Clone Backup 部署文档

## 1. 环境介绍

| 主机          | 角色     | 软件                        | 介绍                                 |
| ------------- | -------- | --------------------------- | ------------------------------------ |
| 172.16.104.56 | Master   | MySQL 8.0.32                | 数据库主节点                         |
| 172.16.104.57 | Replica  | MySQL 8.0.32                | 数据库备节点                         |
| 172.16.104.7  | Metadata | MySQL 8.0.32、Grafana 9.5.3 | 备份元数据中心、Dashboard 部署服务器 |

操作系统版本：CentOS Linux release 7.8.2003 (Core)

当前环境是两个数据库节点，172.16.104.7 这台服务器是专门用来存储和展示备份情况的元数据库中心服务器。

## 2. 安装 Python

该程序可以在 3.6、3.7、3.8 的 Python 环境下运行，如果服务没有对应的 Python 版本，可以通过下面方式安装：

```shell
yum install libffi-devel wget gcc make zlib-devel openssl openssl-devel ncurses-devel openldap-devel gettext bzip2-devel xz-devel
```

```shell
# 下载 Python 源码，如果下载慢，源码包在 github 也传了一份
wget https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tar.xz
# 解压缩
tar -xvJf Python-3.7.0.tar.xz
# 进入目录
cd Python-3.7.0/
# 编译
./configure prefix=/usr/local/python3 
make && make install
# 配置软连接
ln -fs /usr/local/python3/bin/python3 /usr/bin/python3 
ln -fs /usr/local/python3/bin/pip3 /usr/bin/pip3
```

输入 python3 --version 能够返回数据库版本表示安装完成。接下来需要下载依赖包：

```shell
# 更新 pip
pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple --upgrade pip --trusted-host pypi.tuna.tsinghua.edu.cn
# 安装 PyMySQL
pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple PyMySQL==0.7.11 --trusted-host pypi.tuna.tsinghua.edu.cn
# 安装 Minio 如果你使用的是其他类型的 OSS 就不需要安装
pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple Minio==7.1.17 --trusted-host pypi.tuna.tsinghua.edu.cn
```

安装 PyMySQL 过程中，如果出现 urllib3 异常，可以通过下面方式处理：

```shell
pip3 uninstall urllib3
pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple urllib3==1.26.14 --trusted-host pypi.tuna.tsinghua.edu.cn
```

三台服务器都确保 Python 和对应的依赖包安装完成后，即可进入下一步。

## 3. 元数据中心配置

元数据中心库，依赖 MySQL 存储数据，所以也要部署一台 MySQL 数据库，相关文档可参考：[MySQL 自动化部署](https://blog.csdn.net/qq_42768234/article/details/134120072) 这篇文章有安装 MySQL 的内容。

安装完 MySQL 后，需要创建元数据库及对应的表结构：

创建元数据库：

```sql
create database op_service_db;
```

创建数据库实例信息表：

```sql
CREATE TABLE `tb_instance` (
  `id` bigint(64) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `instance_id` varchar(30) NOT NULL COMMENT '实例ID',
  `instance_name` varchar(100) NOT NULL COMMENT '实例名',
  `string_link` varchar(50) NOT NULL COMMENT 'RDS 数据库连接串',
  `db_port` int(11) NOT NULL DEFAULT '3306' COMMENT '数据库端口',
  `system_name` varchar(20) NOT NULL DEFAULT '未规划' COMMENT '所属系统名称',
  `owner_name` varchar(10) NOT NULL DEFAULT '未分配' COMMENT '该数据库负责人',
  `db_type` varchar(10) NOT NULL DEFAULT 'MySQL' COMMENT '数据库类型：MySQL、Oracle',
  `instance_type` varchar(10) NOT NULL DEFAULT 'online' COMMENT '实例类型 云上 online 自建 machine',
  `service_line` varchar(20) NOT NULL DEFAULT '未分配' COMMENT '业务线',
  `enabled` int(1) NOT NULL DEFAULT '1' COMMENT '0 关闭 1 开启',
  `is_clone` int(1) NOT NULL DEFAULT '0' COMMENT '0 不备份 1 开启备份',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uqk_instance` (`instance_id`,`instance_name`),
  KEY `idx_instance_name` (`instance_name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据库实例信息表';
```

创建备份元数据信息表：

```sql
CREATE TABLE `full_backup_metadata` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT '主键',
  `backup_uuid` char(36) NOT NULL COMMENT '备份任务的 uuid 唯一值',
  `tb_instance_id` varchar(50) NOT NULL COMMENT '实例 ID 对应 tb_instance 表中的 ID 字段',
  `state` varchar(10) NOT NULL COMMENT '备份状态：Doing、Done、Tar、Uploading、Clearing、Completed、Error、Expiration',
  `start_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '备份启动的时间',
  `end_time` datetime DEFAULT CURRENT_TIMESTAMP COMMENT '备份结束时间',
  `backup_type` varchar(10) NOT NULL DEFAULT 'full' COMMENT '备份类型 full, binlog',
  `backup_size` varchar(10) NOT NULL DEFAULT '0' COMMENT '备份文件大小',
  `backup_path` varchar(100) NOT NULL COMMENT '备份文件目录',
  `backup_name` varchar(100) NOT NULL COMMENT '备份文件名称',
  `bucket_name` varchar(40) NOT NULL COMMENT 'Bucket 的名称',
  `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `is_delete` int(11) DEFAULT '0' COMMENT '是否删除 OSS 备份 0:未删除 1:确认删除',
  `overdue_day` int(11) DEFAULT '7' COMMENT '备份到期天数，默认保留 7 天',
  `info` varchar(2000) DEFAULT '0' COMMENT '备份的备注信息，如错误信息',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='备份元数据信息表';
```

向数据库中插入需要备份的数据节点信息：

* instance_id：ip:port 该字段主要是为了区分数据库，展示用。
* instance_name：这里写数据库名称，可根据业务来定。
* string_link：这里写数据库的 IP 地址，程序会用该地址访问数据库。
* db_port：这里写数据库端口，程序会用该端口访问数据库。
* system_name：系统名称，可根据业务来定。
* db_type：MySQL 即可。
* instance_type：machine 即可，表示线下实例。
* service_line：业务线，根据业务来定。
* enabled：填 0 即可。
* is_clone：是否开启 clone，可以通过该字段开启或关闭数据库 clone 备份任务，其中 1 表示开启 0 表示不开启。

下面是：172.16.104.56 的节点信息：

```sql
insert into tb_instance(
  instance_id, instance_name, string_link, 
  db_port, system_name, db_type, instance_type, 
  service_line, enabled, is_clone
) value (
  '172.16.104.56:3306', '管理平台-生产环境_node01', 
  '172.16.104.56', 3306, '财务系统', 
  'MySQL', 'machine', '财务', 0, 1
);
```

下面是：172.16.104.57 的节点信息：

```sql
insert into tb_instance(
  instance_id, instance_name, string_link, 
  db_port, system_name, db_type, instance_type, 
  service_line, enabled, is_clone
) value (
  '172.16.104.57:3306', '管理平台-生产环境_node02', 
  '172.16.104.57', 3306, '财务系统', 
  'MySQL', 'machine', '财务', 0, 1
);
```

此时数据已经插入成功：

```sql
select * from tb_instance where is_clone = 1;
```

| id   | instance\_id       | instance\_name            | string\_link | db\_port | system\_name | owner\_name | db\_type | instance\_type | service\_line | enabled | is\_clone |
| :--- | :----------------- | :------------------------ | :----------- | :------- | :----------- | :---------- | :------- | :------------- | :------------ | :------ | :-------- |
| 105  | 172.16.104.56:3306 | 管理平台-生产环境\_node01 | 192.168.8.43 | 3306     | 财务系统     | 未分配      | MySQL    | machine        | 财务          | 0       | 1         |
| 106  | 172.16.104.57:3306 | 管理平台-生产环境\_node02 | 192.168.8.47 | 3306     | 财务系统     | 未分配      | MySQL    | machine        | 财务          | 0       | 1         |

需要记录一下 id 字段的值，因为 full_backup_metadata 表的 `tb_instance_id` 字段与 tb_instance 表的 `id` 字段相关联。

此时数据库已经配置好了，将代码上传到该服务器中。



## 4. 数据节点配置

给两台数据节点，创建用于 clone 备份专用的用户：

```sql
-- 创建用户
create user backup_clone@'127.0.0.1' identified by 'admin123';
-- 授予本地克隆权限
GRANT BACKUP_ADMIN, Reload ON *.* TO backup_clone@'127.0.0.1';
-- 授予克隆信息查看权限
GRANT SELECT ON performance_schema.clone_status TO backup_clone@'127.0.0.1';
```

